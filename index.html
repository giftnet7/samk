<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ታዳጊ - መ</title>
    <link rel="icon" type="image/x-icon" href="44.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Updated CDN links with fallbacks -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        .hidden {
            display: none;
        }
        .status-btn {
            min-width: 80px;
        }
        .student-card {
            transition: all 0.3s ease;
        }
        .student-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .download-btn {
            background: linear-gradient(to right, #4facfe 0%, #00f2fe 100%);
        }
        .download-btn:hover {
            background: linear-gradient(to right, #3a8fd4 0%, #00c9d4 100%);
        }
        .excel-btn {
            background: linear-gradient(to right, #21a366 0%, #33c481 100%);
        }
        .excel-btn:hover {
            background: linear-gradient(to right, #1a8a57 0%, #2aac70 100%);
        }
        .reset-btn {
            background: linear-gradient(to right, #ff5e62 0%, #ff9966 100%);
        }
        .reset-btn:hover {
            background: linear-gradient(to right, #e05557 0%, #e58a5c 100%);
        }
        .delete-btn {
            background: linear-gradient(to right, #ff5e62 0%, #ff9966 100%);
        }
        .delete-btn:hover {
            background: linear-gradient(to right, #e05557 0%, #e58a5c 100%);
        }
        .connection-status {
            background-color: #fffbeb;
            border-left: 4px solid #f59e0b;
        }
        .search-highlight {
            background-color: #ffeb3b;
            padding: 0 2px;
            border-radius: 2px;
        }
        .summary-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .date-history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        .status-icon {
            font-size: 1.2rem;
            display: inline-block;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
        }
        .present-icon {
            background-color: #10B981;
            color: white;
        }
        .absent-icon {
            background-color: #EF4444;
            color: white;
        }
        .alert-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #EF4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        .alert-student {
            border-left: 4px solid #EF4444;
            background-color: #FEF2F2;
        }
        .date-range-container {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        .date-range-input {
            flex: 1;
            min-width: 140px;
        }
        .summary-search-highlight {
            background-color: #ffeb3b;
            border-radius: 3px;
            padding: 0 2px;
        }
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }
        .history-table th, .history-table td {
            border: 1px solid #e5e7eb;
            padding: 8px 12px;
            text-align: left;
        }
        .history-table th {
            background-color: #f9fafb;
            font-weight: 600;
        }
        .history-table tr:nth-child(even) {
            background-color: #f9fafb;
        }
        .history-table tr:hover {
            background-color: #f3f4f6;
        }
        .present-cell {
            background-color: #dcfce7;
            color: #166534;
            text-align: center;
            font-weight: 600;
        }
        .absent-cell {
            background-color: #fee2e2;
            color: #991b1b;
            text-align: center;
            font-weight: 600;
        }
        .toggle-history-btn {
            background: linear-gradient(to right, #8b5cf6 0%, #a855f7 100%);
        }
        .toggle-history-btn:hover {
            background: linear-gradient(to right, #7c3aed 0%, #9333ea 100%);
        }
        .scrollable-table {
            overflow-x: auto;
            max-width: 100%;
            margin-top: 16px;
        }
        .absence-dates {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 4px;
        }
        .absence-date {
            display: inline-block;
            background-color: #fee2e2;
            color: #991b1b;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 6px;
            margin-bottom: 4px;
            font-size: 0.75rem;
        }
        .alert-details {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #fca5a5;
        }
        .gender-filter {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .gender-btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .gender-btn.active {
            background-color: #4F46E5;
            color: white;
        }
        .gender-btn.inactive {
            background-color: #E5E7EB;
            color: #4B5563;
        }
        .gender-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }
        .male-tag {
            background-color: #DBEAFE;
            color: #1E40AF;
        }
        .female-tag {
            background-color: #FCE7F3;
            color: #9D174D;
        }
        .edit-mode {
            background-color: #fef3c7;
            border: 1px dashed #f59e0b;
        }
        .permission-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
            background-color: #fef3c7;
            color: #92400e;
        }
        .admin-badge {
            background-color: #fef3c7;
            color: #92400e;
        }
        .user-badge {
            background-color: #dbeafe;
            color: #1e40af;
        }
        .permission-cell {
            background-color: #fef3c7;
            color: #92400e;
            text-align: center;
            font-weight: 600;
        }
        .session-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
            background-color: #dbeafe;
            color: #1e40af;
        }
        .permission-btn {
            background-color: #fbbf24;
            color: #92400e;
        }
        .permission-btn:hover {
            background-color: #f59e0b;
        }
        .permission-btn.active {
            background-color: #d97706;
            color: white;
        }
        .session-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .session-btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            background-color: #e5e7eb;
            color: #4b5563;
            transition: all 0.3s ease;
        }
        .session-btn.active {
            background-color: #4F46E5;
            color: white;
        }
        .permission-info {
            font-size: 0.875rem;
            color: #92400e;
            background-color: #fef3c7;
            padding: 8px;
            border-radius: 8px;
            margin-top: 8px;
            margin-bottom: 16px;
        }
        .permission-warning {
            color: #dc2626;
            font-weight: 600;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }
        .error-message {
            background-color: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
            padding: 16px;
            border-radius: 8px;
            margin: 10px 0;
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 flex flex-col items-center">
    <div class="w-full max-w-6xl bg-white rounded-2xl shadow-xl p-6 sm:p-8 text-gray-900">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-indigo-600 mb-2">ፈለገ ህይወት ሰ/ት/ቤት</h1>
        <p class="text-center text-sm sm:text-base text-gray-600 mb-6">ታዳጊ - መ ስም መጥሪያ</p>

        <!-- Navigation Buttons -->
        <div class="flex justify-center gap-4 mb-6">
            <button id="showDailyBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                Daily Attendance
            </button>
            <button id="showAdminBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 relative">
                Admin Panel
                <span id="adminAlertBadge" class="alert-badge hidden">0</span>
            </button>
        </div>

        <!-- Daily Attendance Section -->
        <div id="dailyAttendanceSection">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Daily Attendance</h2>
            
            <!-- Date and Session Selection -->
            <div class="flex flex-col mb-4">
                <div class="flex justify-between items-center mb-2">
                    <label for="date-picker" class="text-sm font-semibold text-gray-700">Select Attendance Date</label>
                    <span id="sessionIndicator" class="text-sm font-semibold text-indigo-600">Session: Morning</span>
                </div>
                <input type="date" id="date-picker" class="p-3 rounded-lg border-2 border-gray-300 bg-gray-100 text-gray-900 focus:outline-none focus:border-indigo-500 mb-4">
                
                <!-- Session Selector -->
                <div class="session-selector">
                    <button id="sessionMorning" class="session-btn active">ትምህርት</button>
                    <button id="sessionAfternoon" class="session-btn">መዝሙር</button>
                    <button id="sessionEvening" class="session-btn">other</button>
                </div>
            </div>
            
            <!-- Gender Filter -->
            <div class="gender-filter">
                <button id="allGenderBtn" class="gender-btn active">All</button>
                <button id="maleGenderBtn" class="gender-btn inactive">Male</button>
                <button id="femaleGenderBtn" class="gender-btn inactive">Female</button>
            </div>
            
            <!-- Search Box -->
            <div class="mb-4">
                <label for="studentSearch" class="mb-2 text-sm font-semibold text-gray-700">Search Students</label>
                <input type="text" id="studentSearch" placeholder="Type to search students..." class="w-full p-3 rounded-lg border-2 border-gray-300 bg-white text-gray-900 focus:outline-none focus:border-indigo-500">
            </div>
            
            <div id="permissionInfo" class="permission-info hidden">
                <!-- Permission info will be displayed here -->
            </div>
            
            <div id="dailyAttendanceContainer" class="space-y-4">
                <div class="loading">Loading students...</div>
            </div>
            
            <div class="flex justify-center mt-4">
                <button id="finalizeButton" type="button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 transform hover:scale-105">
                    Save Attendance
                </button>
            </div>
            <div id="exportMessage" class="text-center text-sm my-2 text-gray-600"></div>
        </div>

        <!-- Admin Password Section -->
        <div id="adminPasswordSection" class="hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Admin Access</h2>
            <div class="bg-gray-100 p-6 rounded-xl shadow-md flex flex-col items-center">
                <p class="mb-4 text-center text-gray-700">Please enter the password to access the Admin Panel.</p>
                <input type="password" id="adminPasswordInput" placeholder="Enter password" class="w-full max-w-xs p-3 rounded-lg border-2 border-gray-300 bg-white text-gray-900 focus:outline-none focus:border-indigo-500 mb-4 text-center">
                <button id="submitPasswordBtn" type="button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 transform hover:scale-105">
                    Submit
                </button>
                <p id="passwordMessage" class="mt-4 text-sm text-red-500"></p>
            </div>
        </div>

        <!-- Admin Panel Section -->
        <div id="adminSection" class="hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Admin Panel</h2>

            <!-- Permission Management Section -->
            <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-xl mb-6">
                <h3 class="text-xl font-bold mb-2 text-yellow-800">Permission Management</h3>
                
                <!-- Add Permission -->
                <div class="flex flex-col sm:flex-row gap-3 mb-4">
                    <select id="permissionStudentSelect" class="flex-grow p-3 rounded-lg border-2 border-gray-300 bg-white text-gray-900 focus:outline-none focus:border-indigo-500">
                        <!-- Students will be populated here -->
                    </select>
                    <input type="date" id="permissionDate" class="p-3 rounded-lg border-2 border-gray-300 bg-white text-gray-900 focus:outline-none focus:border-indigo-500">
                    <button id="addPermissionBtn" type="button" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300">
                        Add Permission
                    </button>
                </div>
                
                <!-- Permission Limits Info -->
                <div class="bg-yellow-100 p-3 rounded-lg mb-4">
                    <p class="text-sm text-yellow-800">
                        <strong>Note:</strong> Students can have maximum 3 permissions per month. 
                        Permission counts as Present attendance.
                    </p>
                </div>
                
                <!-- Active Permissions List -->
                <div id="permissionList" class="space-y-2 max-h-48 overflow-y-auto">
                    <!-- Permissions will be rendered here -->
                </div>
            </div>

            <!-- Absence Alerts Section -->
            <div id="absenceAlertsContainer" class="bg-red-50 border border-red-200 rounded-xl p-4 mb-6">
                <h3 class="text-xl font-bold mb-2 text-red-800 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                    Absence Alerts (Last 3 Months)
                </h3>
                <p class="text-sm text-red-600 mb-3">Students with 10 or more absences in the last 3 months:</p>
                <div id="absenceAlertsList" class="space-y-2">
                    <!-- Alerts will be populated here -->
                </div>
            </div>

            <!-- Master Student List Management -->
            <div class="bg-gray-100 p-4 rounded-xl mb-6">
                <h3 class="text-xl font-bold mb-2">Manage Student Roster</h3>
                <div class="flex flex-col sm:flex-row gap-3 mb-4">
                    <input type="text" id="newStudentName" placeholder="Enter new student name" class="flex-grow p-3 rounded-lg border-2 border-gray-300 bg-white text-gray-900 focus:outline-none focus:border-indigo-500">
                    <select id="newStudentGender" class="p-3 rounded-lg border-2 border-gray-300 bg-white text-gray-900 focus:outline-none focus:border-indigo-500">
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                    <button id="addStudentBtn" type="button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 transform hover:scale-105">
                        Add Student
                    </button>
                </div>
                <div id="masterStudentList" class="space-y-2 max-h-48 overflow-y-auto">
                    <!-- Master students will be rendered here -->
                </div>
            </div>

            <!-- Attendance Summary -->
            <div>
                <h3 class="text-xl font-bold mb-2">Attendance Summary (Cumulative)</h3>
                
                <!-- Date Range Selector -->
                <div class="mb-4 bg-blue-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-blue-800 mb-2">Select Date Range</h4>
                    <div class="date-range-container">
                        <div class="date-range-input">
                            <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                            <input type="date" id="startDate" class="w-full p-2 rounded border border-gray-300">
                        </div>
                        <div class="date-range-input">
                            <label for="endDate" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                            <input type="date" id="endDate" class="w-full p-2 rounded border border-gray-300">
                        </div>
                        <div class="flex items-end">
                            <button id="applyDateRange" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-300 h-10">
                                Apply
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Summary Search Box -->
                <div class="mb-4">
                    <label for="summarySearch" class="block text-sm font-medium text-gray-700 mb-1">Search Students in Summary</label>
                    <input type="text" id="summarySearch" placeholder="Type to search students in summary..." class="w-full p-3 rounded-lg border-2 border-gray-300 bg-white text-gray-900 focus:outline-none focus:border-indigo-500">
                </div>

                <!-- Toggle between summary and detailed history -->
                <div class="flex gap-2 mb-4">
                    <button id="showSummaryView" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded transition duration-300">
                        Summary View
                    </button>
                    <button id="showHistoryView" class="toggle-history-btn text-white font-bold py-2 px-4 rounded transition duration-300">
                        Detailed History
                    </button>
                </div>
                
                <!-- Summary View -->
                <div id="summaryView">
                    <div id="attendanceSummary" class="space-y-4">
                        <!-- Summary will be rendered here -->
                    </div>
                </div>

                <!-- Detailed History View -->
                <div id="detailedHistoryView" class="hidden">
                    <div class="bg-gray-50 p-4 rounded-lg mb-4">
                        <p class="text-sm text-gray-600">Showing detailed attendance history for all dates. Scroll horizontally to see all dates.</p>
                    </div>
                    <div class="scrollable-table">
                        <table id="completeHistoryTable" class="history-table">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <!-- Dates will be added here dynamically -->
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Student rows will be added here dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- PDF Export and Reset Buttons -->
                <div class="summary-actions">
                    <button id="saveSummaryPdfBtn" type="button" class="download-btn text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                        Save Summary to PDF
                    </button>
                    <button id="saveHistoryExcelBtn" type="button" class="excel-btn text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                        Export History to Excel
                    </button>
                    <button id="resetSummaryBtn" type="button" class="reset-btn text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                        Reset All Data
                    </button>
                </div>
            </div>

            <!-- New Section: Attendance History by Date -->
            <div class="mt-8">
                <h3 class="text-xl font-bold mb-2">Attendance History by Date</h3>
                <div id="dateHistoryList" class="space-y-2">
                    <!-- List of finalized dates will be rendered here -->
                </div>
                <div id="dateDetailView" class="mt-4 space-y-4 hidden">
                    <h4 id="historyDateTitle" class="text-lg font-semibold"></h4>
                    <div id="historyDetailContainer" class="space-y-2">
                        <!-- Detailed attendance for a selected date will be rendered here -->
                    </div>
                    <div class="flex justify-between gap-4">
                        <button id="closeDateViewBtn" type="button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 mt-4 flex-grow">
                            Back to Dates
                        </button>
                        <button id="saveExcelBtn" type="button" class="excel-btn text-white font-bold py-2 px-4 rounded-lg transition duration-300 mt-4 flex-grow">
                            Export to Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal for Reset -->
    <div id="resetModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Confirm Reset</h3>
            <p class="text-gray-600 mb-6">Are you sure you want to reset all attendance data? This action cannot be undone.</p>
            <div class="flex justify-end gap-4">
                <button id="cancelResetBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">
                    Cancel
                </button>
                <button id="confirmResetBtn" class="reset-btn text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                    Reset All Data
                </button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal for Date Deletion -->
    <div id="deleteDateModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Confirm Deletion</h3>
            <p id="deleteDateMessage" class="text-gray-600 mb-6">Are you sure you want to delete attendance data for this date?</p>
            <div class="flex justify-end gap-4">
                <button id="cancelDeleteBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">
                    Cancel
                </button>
                <button id="confirmDeleteBtn" class="delete-btn text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Student Modal -->
    <div id="editStudentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Edit Student</h3>
            <div class="mb-4">
                <label for="editStudentName" class="block text-sm font-medium text-gray-700 mb-1">Student Name</label>
                <input type="text" id="editStudentName" class="w-full p-3 rounded-lg border-2 border-gray-300 bg-white text-gray-900 focus:outline-none focus:border-indigo-500">
            </div>
            <div class="mb-4">
                <label for="editStudentGender" class="block text-sm font-medium text-gray-700 mb-1">Gender</label>
                <select id="editStudentGender" class="w-full p-3 rounded-lg border-2 border-gray-300 bg-white text-gray-900 focus:outline-none focus:border-indigo-500">
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                </select>
            </div>
            <div class="flex justify-end gap-4">
                <button id="cancelEditBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">
                    Cancel
                </button>
                <button id="saveEditBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Permission Modal -->
    <div id="permissionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Add Permission</h3>
            <div class="mb-4">
                <label for="modalPermissionDate" class="block text-sm font-medium text-gray-700 mb-1">Permission Date</label>
                <input type="date" id="modalPermissionDate" class="w-full p-3 rounded-lg border-2 border-gray-300 bg-white text-gray-900 focus:outline-none focus:border-indigo-500">
            </div>
            <div class="mb-4">
                <label for="permissionReason" class="block text-sm font-medium text-gray-700 mb-1">Reason (Optional)</label>
                <textarea id="permissionReason" rows="3" class="w-full p-3 rounded-lg border-2 border-gray-300 bg-white text-gray-900 focus:outline-none focus:border-indigo-500" placeholder="Enter reason for permission"></textarea>
            </div>
            <div id="permissionLimitWarning" class="text-red-600 text-sm mb-4 hidden">
                Warning: This student already has 3 permissions this month!
            </div>
            <div class="flex justify-end gap-4">
                <button id="cancelPermissionBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">
                    Cancel
                </button>
                <button id="savePermissionBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                    Save Permission
                </button>
            </div>
        </div>
    </div>

    <script>
        // Error handling
        window.addEventListener('error', function(e) {
            console.error('Global error caught:', e.error);
            document.getElementById('dailyAttendanceContainer').innerHTML = 
                `<div class="error-message">
                    <p>An error occurred: ${e.message}</p>
                    <p>Please refresh the page and try again.</p>
                </div>`;
        });

        // Check if required libraries are loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded successfully');
            
            if (typeof window.jspdf === 'undefined') {
                console.warn('jspdf not loaded - PDF export will be disabled');
                document.getElementById('saveSummaryPdfBtn').disabled = true;
                document.getElementById('saveSummaryPdfBtn').innerText = 'PDF Export (Library Missing)';
            }
            
            if (typeof XLSX === 'undefined') {
                console.warn('XLSX not loaded - Excel export will be disabled');
                document.getElementById('saveHistoryExcelBtn').disabled = true;
                document.getElementById('saveExcelBtn').disabled = true;
                document.getElementById('saveHistoryExcelBtn').innerText = 'Excel Export (Library Missing)';
            }
        });

        // Initialize data structure with permissions and sessions
        const initializeData = () => {
            try {
                if (!localStorage.getItem('attendanceData')) {
                    const defaultData = {
                        masterStudents: [
    
    {"name": "ኑሀሚን አንድነት", "gender": "female"},
    {"name": "ሳሮን ዳንኤል", "gender": "female"},
    {"name": "አቤኔዘር ይርጋለም", "gender": "male"},
    {"name": "ሜሮን ግርማ", "gender": "female"},
    {"name": "ናፍያድ ቀነኒሳ", "gender": "male"},
    {"name": "ፅናት ወልዱ", "gender": "female"},
    {"name": "ቅድስት ታደሰ", "gender": "female"},
    {"name": "ምህረት ጋሻው", "gender": "female"},
    {"name": "ዮርዳኖስ ታጠቅ", "gender": "female"},
    {"name": "ናታኒም ምትኩ", "gender": "male"},
    {"name": "አቤኔዘር ጥላሁን", "gender": "male"},
    {"name": "ኑሀሚን ታልጌታ", "gender": "female"},
    {"name": "አማኑኤል ቀነኒሳ", "gender": "male"},
    {"name": "ናታን ስዮም", "gender": "male"},
    {"name": "ተመስገን ተ/ብርሀን", "gender": "male"},
    {"name": "ፋኑኤል እንዳልካቸው", "gender": "male"},
    {"name": "ማራናታ ዝናዬ", "gender": "female"},
    {"name": "ማራማዊት ዮናስ", "gender": "female"},
    {"name": "እድላዊት ደስታ", "gender": "female"},
    {"name": "ኤልዳና አበበ", "gender": "male"},
    {"name": "ሜሮን ስዮም", "gender": "female"},
    {"name": "ካሌብ ሐኮንን", "gender": "male"},
    {"name": "ዳዊት እንዳየ", "gender": "male"},
    {"name": "በፀሎት ዘመተ", "gender": "female"},
    {"name": "የአብ ዘር ይድነቃቸው", "gender": "female"},
    {"name": "አቢሲኒያ ፍቃዱ", "gender": "female"},
    {"name": "ሶሊያና ሀይሉ", "gender": "female"},
    {"name": "ህይወት ታሪኩ", "gender": "female"},
    {"name": "በእምነት ከፍያለው", "gender": "female"},
    {"name": "ፍቅር አዲስ", "gender": "male"},
    {"name": "አብርሀም ወንድሜ", "gender": "male"},
    {"name": "መክሊት አራጌ", "gender": "female"},
    {"name": "ምኞት ታደለ", "gender": "female"},
    {"name": "ብሌን ካሳሁን", "gender": "female"},
    {"name": "ኬና ቶሌሳ", "gender": "male"},
    {"name": "ያብስራ ካሳሁን", "gender": "female"},
    {"name": "ናትናኤል ሽመልስ", "gender": "male"},
    {"name": "ሄኖክ ጉልማ", "gender": "male"},
    {"name": "ቃልአብ ቁምላቸው", "gender": "male"},
    {"name": "ኤዶምያስ ዘረፈ", "gender": "male"},
    {"name": "ሱራፊል ምንዳ", "gender": "male"},
    {"name": "አሸናፊ ፍቅሪ", "gender": "male"},
    {"name": "በእምነት አንበሳ", "gender": "male"},
    {"name": "በሱፍቃድ ዘሪሁን", "gender": "male"},
    {"name": "ኪሩቤል ነጋ", "gender": "male"},
    {"name": "በፀሎት ዘመት", "gender": "female"},
    {"name": "መልክኤል እዮብ", "gender": "male"},
    {"name": "ፍሌበር ደረጀ", "gender": "male"},
    {"name": "ህይወት ታሪኩ", "gender": "female"},
    {"name": "ፍቅር አዲስ", "gender": "male"},
    {"name": "ህይወት ተመስገን", "gender": "female"},
    {"name": "ባምላክ አለሜነህ", "gender": "male"},
    {"name": "ቅድስት አሸናፊ", "gender": "female"},
    {"name": "ሰላም አሸናፊ", "gender": "female"},
    {"name": "ቅድስት መላኩ", "gender": "female"},
    {"name": "ሜላት መንክር", "gender": "female"},
    {"name": "ኤልዳና አበበ", "gender": "male"},
    {"name": "ናታኒም ጌታሁን", "gender": "male"},
    {"name": "ኤልያና ኤርምያስ", "gender": "female"},
    {"name": "አኪያ ባርክልኝ", "gender": "female"},
    {"name": "ይስሀቅ አብርሀም", "gender": "male"},
    {"name": "እዮኤል ደረጀ", "gender": "male"},
    {"name": "ሱራፊል ገ/ማርያም", "gender": "female"},
    {"name": "አዶናይ ደረጀ", "gender": "male"},
    {"name": "ማእዶት ተገኘ", "gender": "female"},
    {"name": "አቤል ነጋ", "gender": "male"}
  

  
                        ],
                        attendanceRecords: {},
                        finalizedRecords: {},
                        permissions: {}, // Structure: {studentName: [{date: "YYYY-MM-DD", reason: "...", monthYear: "YYYY-MM"}]}
                        sessions: {}, // Structure: {date: {sessionName: {studentName: status}}}
                        users: [
                            {username: "admin", password: "0730", role: "admin"},
                            {username: "user", password: "1234", role: "user"}
                        ]
                    };
                    localStorage.setItem('attendanceData', JSON.stringify(defaultData));
                    return defaultData;
                }
                
                const data = JSON.parse(localStorage.getItem('attendanceData'));
                
                // Ensure all required properties exist
                if (!data.masterStudents) data.masterStudents = [];
                if (!data.attendanceRecords) data.attendanceRecords = {};
                if (!data.finalizedRecords) data.finalizedRecords = {};
                if (!data.permissions) data.permissions = {};
                if (!data.sessions) data.sessions = {};
                if (!data.users) data.users = [
                    {username: "admin", password: "0730", role: "admin"},
                    {username: "user", password: "1234", role: "user"}
                ];
                
                return data;
                
            } catch (error) {
                console.error('Error loading data:', error);
                // Return minimal default data
                return {
                    masterStudents: [],
                    attendanceRecords: {},
                    finalizedRecords: {},
                    permissions: {},
                    sessions: {},
                    users: [
                        {username: "admin", password: "0730", role: "admin"},
                        {username: "user", password: "1234", role: "user"}
                    ]
                };
            }
        };

        let appData = initializeData();
        let currentDate = new Date().toISOString().split('T')[0];
        let currentSession = 'morning'; // Default session
        let currentPermissionStudent = null;
        let dateToDelete = null;
        let currentHistoryDate = null;
        let dateRange = {
            start: null,
            end: null
        };
        let currentGenderFilter = 'all';
        let currentEditStudent = null;

        // DOM Elements
        const dailyAttendanceSection = document.getElementById('dailyAttendanceSection');
        const adminSection = document.getElementById('adminSection');
        const adminPasswordSection = document.getElementById('adminPasswordSection');
        const showDailyBtn = document.getElementById('showDailyBtn');
        const showAdminBtn = document.getElementById('showAdminBtn');
        const adminPasswordInput = document.getElementById('adminPasswordInput');
        const submitPasswordBtn = document.getElementById('submitPasswordBtn');
        const passwordMessage = document.getElementById('passwordMessage');
        const adminAlertBadge = document.getElementById('adminAlertBadge');

        const dailyAttendanceContainer = document.getElementById('dailyAttendanceContainer');
        const datePicker = document.getElementById('date-picker');
        const studentSearchInput = document.getElementById('studentSearch');
        const summarySearchInput = document.getElementById('summarySearch');
        const addStudentBtn = document.getElementById('addStudentBtn');
        const newStudentNameInput = document.getElementById('newStudentName');
        const newStudentGenderSelect = document.getElementById('newStudentGender');
        const masterStudentListDiv = document.getElementById('masterStudentList');
        const attendanceSummaryDiv = document.getElementById('attendanceSummary');
        const finalizeButton = document.getElementById('finalizeButton');
        const exportMessageDiv = document.getElementById('exportMessage');

        // Gender filter buttons
        const allGenderBtn = document.getElementById('allGenderBtn');
        const maleGenderBtn = document.getElementById('maleGenderBtn');
        const femaleGenderBtn = document.getElementById('femaleGenderBtn');

        // New elements for absence alerts
        const absenceAlertsContainer = document.getElementById('absenceAlertsContainer');
        const absenceAlertsList = document.getElementById('absenceAlertsList');

        // New elements for date range
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const applyDateRangeBtn = document.getElementById('applyDateRange');

        // New elements for summary/history toggle
        const summaryView = document.getElementById('summaryView');
        const detailedHistoryView = document.getElementById('detailedHistoryView');
        const showSummaryViewBtn = document.getElementById('showSummaryView');
        const showHistoryViewBtn = document.getElementById('showHistoryView');
        const completeHistoryTable = document.getElementById('completeHistoryTable');

        // New elements for date history
        const dateHistoryListDiv = document.getElementById('dateHistoryList');
        const dateDetailView = document.getElementById('dateDetailView');
        const historyDateTitle = document.getElementById('historyDateTitle');
        const historyDetailContainer = document.getElementById('historyDetailContainer');
        const closeDateViewBtn = document.getElementById('closeDateViewBtn');
        const saveExcelBtn = document.getElementById('saveExcelBtn');

        // New elements for summary actions
        const saveSummaryPdfBtn = document.getElementById('saveSummaryPdfBtn');
        const saveHistoryExcelBtn = document.getElementById('saveHistoryExcelBtn');
        const resetSummaryBtn = document.getElementById('resetSummaryBtn');
        const resetModal = document.getElementById('resetModal');
        const cancelResetBtn = document.getElementById('cancelResetBtn');
        const confirmResetBtn = document.getElementById('confirmResetBtn');

        // Elements for date deletion
        const deleteDateModal = document.getElementById('deleteDateModal');
        const deleteDateMessage = document.getElementById('deleteDateMessage');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

        // Elements for student editing
        const editStudentModal = document.getElementById('editStudentModal');
        const editStudentNameInput = document.getElementById('editStudentName');
        const editStudentGenderSelect = document.getElementById('editStudentGender');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const saveEditBtn = document.getElementById('saveEditBtn');

        // Permission elements
        const permissionInfoDiv = document.getElementById('permissionInfo');
        const permissionModal = document.getElementById('permissionModal');
        const modalPermissionDateInput = document.getElementById('modalPermissionDate');
        const permissionReasonInput = document.getElementById('permissionReason');
        const permissionLimitWarningDiv = document.getElementById('permissionLimitWarning');
        const cancelPermissionBtn = document.getElementById('cancelPermissionBtn');
        const savePermissionBtn = document.getElementById('savePermissionBtn');
        const sessionMorningBtn = document.getElementById('sessionMorning');
        const sessionAfternoonBtn = document.getElementById('sessionAfternoon');
        const sessionEveningBtn = document.getElementById('sessionEvening');
        const sessionIndicator = document.getElementById('sessionIndicator');
        const permissionStudentSelect = document.getElementById('permissionStudentSelect');
        const permissionDateInput = document.getElementById('permissionDate');
        const addPermissionBtn = document.getElementById('addPermissionBtn');
        const permissionListDiv = document.getElementById('permissionList');

        // Set initial dates
        datePicker.value = currentDate;
        permissionDateInput.value = currentDate;
        modalPermissionDateInput.value = currentDate;
        
        // Set default date range (last 3 months)
        const threeMonthsAgo = new Date();
        threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
        startDateInput.value = threeMonthsAgo.toISOString().split('T')[0];
        endDateInput.value = currentDate;
        dateRange.start = startDateInput.value;
        dateRange.end = endDateInput.value;

        // Initialize the application
        function initializeApp() {
            try {
                console.log('Initializing app with', appData.masterStudents.length, 'students');
                
                renderMasterStudents();
                setupDailyAttendanceListener();
                renderSummary();
                renderDateHistoryList();
                checkAbsenceAlerts();
                updateAdminAlertBadge();
                updatePermissionList();
                setSession('morning');
                
                console.log('App initialized successfully');
            } catch (error) {
                console.error('Error in initializeApp:', error);
                dailyAttendanceContainer.innerHTML = 
                    `<div class="error-message">
                        <p>Error loading application: ${error.message}</p>
                        <p>Please refresh the page or clear browser data if the problem persists.</p>
                    </div>`;
            }
        }

        function setupDailyAttendanceListener() {
            try {
                const selectedDate = datePicker.value;
                renderDailyStudents(selectedDate);
            } catch (error) {
                console.error('Error in setupDailyAttendanceListener:', error);
            }
        }

        // Render functions
        function renderDailyStudents(date, searchTerm = '') {
            try {
                dailyAttendanceContainer.innerHTML = '';
                
                if (appData.masterStudents.length === 0) {
                    dailyAttendanceContainer.innerHTML = `
                        <div class="text-center text-gray-500 p-8 border-2 border-dashed border-gray-300 rounded-xl">
                            <p>No students in the master list. Please add students in the Admin Panel.</p>
                        </div>`;
                    return;
                }
                
                // Initialize session data for this date
                if (!appData.sessions[date]) {
                    appData.sessions[date] = {};
                }
                if (!appData.sessions[date][currentSession]) {
                    appData.sessions[date][currentSession] = {};
                }
                
                // Filter students based on search term and gender
                const filteredStudents = appData.masterStudents.filter(student => {
                    if (currentGenderFilter !== 'all' && student.gender !== currentGenderFilter) {
                        return false;
                    }
                    if (searchTerm && !student.name.toLowerCase().includes(searchTerm.toLowerCase())) {
                        return false;
                    }
                    return true;
                });
                
                if (filteredStudents.length === 0) {
                    dailyAttendanceContainer.innerHTML = `
                        <div class="text-center text-gray-500 p-8 border-2 border-dashed border-gray-300 rounded-xl">
                            <p>No students match your search.</p>
                        </div>`;
                    return;
                }
                
                // Check if today has any permissions
                const todayPermissions = filteredStudents.filter(student => 
                    hasPermissionOnDate(student.name, date)
                );
                
                if (todayPermissions.length > 0) {
                    permissionInfoDiv.classList.remove('hidden');
                    permissionInfoDiv.innerHTML = `
                        <strong>Note:</strong> ${todayPermissions.length} student(s) have permission today:
                        ${todayPermissions.map(s => s.name).join(', ')}. They are automatically marked as Present.
                    `;
                } else {
                    permissionInfoDiv.classList.add('hidden');
                }
                
                filteredStudents.forEach(student => {
                    // Check if student has permission for this date
                    const hasPermission = hasPermissionOnDate(student.name, date);
                    
                    // If student has permission, they are automatically Present
                    let status = hasPermission ? 'Present' : 
                        (appData.sessions[date][currentSession][student.name] || 'Absent');
                    
                    // Highlight search term in student name
                    let displayName = student.name;
                    if (searchTerm) {
                        const regex = new RegExp(`(${searchTerm})`, 'gi');
                        displayName = student.name.replace(regex, '<span class="search-highlight">$1</span>');
                    }
                    
                    const genderTag = student.gender === 'male' ? 
                        '<span class="gender-tag male-tag">Male</span>' : 
                        '<span class="gender-tag female-tag">Female</span>';
                    
                    // Permission badge if student has permission today
                    const permissionBadge = hasPermission ? 
                        '<span class="permission-badge">Permission</span>' : '';
                    
                    // Check permission count for this month
                    const monthlyPermissions = getMonthlyPermissionCount(student.name, date);
                    const permissionCountText = monthlyPermissions >= 3 ? 
                        `<span class="permission-warning">(${monthlyPermissions}/3 this month)</span>` : 
                        `(${monthlyPermissions}/3 this month)`;
                    
                    const studentDiv = document.createElement('div');
                    studentDiv.className = 'student-card flex flex-col sm:flex-row items-center justify-between bg-white p-4 rounded-xl shadow-sm transition duration-300 hover:shadow-md fade-in';
                    studentDiv.innerHTML = `
                        <div class="w-full sm:w-1/2 mb-2 sm:mb-0">
                            <div class="flex flex-col">
                                <span class="text-lg font-medium truncate text-gray-900">${displayName} ${genderTag} ${permissionBadge}</span>
                                <span class="text-xs text-gray-500 mt-1">${permissionCountText}</span>
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-2">
                            ${!hasPermission ? `
                                <button data-student-name="${student.name}" data-status="Present" class="status-btn px-4 py-2 rounded-full font-semibold text-sm transition duration-300 ${status === 'Present' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-green-200'}">✔️ Present</button>
                                <button data-student-name="${student.name}" data-status="Absent" class="status-btn px-4 py-2 rounded-full font-semibold text-sm transition duration-300 ${status === 'Absent' ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-red-200'}">✖️ Absent</button>
                                <button data-student-name="${student.name}" class="give-permission-btn permission-btn px-4 py-2 rounded-full font-semibold text-sm transition duration-300 hover:bg-yellow-500">📝 Permission</button>
                            ` : `
                                <button disabled class="px-4 py-2 rounded-full font-semibold text-sm bg-green-500 text-white">✔️ Present (Permission)</button>
                                <button data-student-name="${student.name}" class="remove-permission-btn bg-red-500 text-white px-4 py-2 rounded-full font-semibold text-sm">Remove Permission</button>
                            `}
                        </div>
                    `;
                    dailyAttendanceContainer.appendChild(studentDiv);
                });
                
                localStorage.setItem('attendanceData', JSON.stringify(appData));
            } catch (error) {
                console.error('Error in renderDailyStudents:', error);
                dailyAttendanceContainer.innerHTML = 
                    `<div class="error-message">
                        <p>Error displaying students: ${error.message}</p>
                    </div>`;
            }
        }

        function renderMasterStudents() {
            try {
                masterStudentListDiv.innerHTML = '';
                
                if (appData.masterStudents.length === 0) {
                    masterStudentListDiv.innerHTML = `<p class="text-sm text-gray-600">No students in master list. Add students above.</p>`;
                    return;
                }
                
                appData.masterStudents.forEach(student => {
                    const genderTag = student.gender === 'male' ? 
                        '<span class="gender-tag male-tag">Male</span>' : 
                        '<span class="gender-tag female-tag">Female</span>';
                    
                    const studentDiv = document.createElement('div');
                    studentDiv.className = 'flex items-center justify-between p-2 bg-gray-50 rounded-lg fade-in';
                    studentDiv.innerHTML = `
                        <div>
                            <span class="truncate text-gray-900">${student.name}</span>
                            ${genderTag}
                        </div>
                        <div class="flex gap-2">
                            <button data-student-name="${student.name}" class="edit-student-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded-lg text-sm transition duration-300">Edit</button>
                            <button data-student-name="${student.name}" class="remove-btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-sm transition duration-300">Remove</button>
                        </div>
                    `;
                    masterStudentListDiv.appendChild(studentDiv);
                });
            } catch (error) {
                console.error('Error in renderMasterStudents:', error);
                masterStudentListDiv.innerHTML = 
                    `<div class="error-message">
                        <p>Error loading student list</p>
                    </div>`;
            }
        }

        function renderSummary(searchTerm = '') {
            try {
                attendanceSummaryDiv.innerHTML = '';
                
                if (Object.keys(appData.finalizedRecords).length === 0) {
                    attendanceSummaryDiv.innerHTML = `<p class="text-sm text-gray-600">No finalized data available. Finalize a day to see a summary.</p>`;
                    return;
                }
                
                const summary = {};
                
                // Calculate summary from finalized records within date range
                Object.entries(appData.finalizedRecords).forEach(([date, sessions]) => {
                    // Skip dates outside the selected range
                    if (dateRange.start && date < dateRange.start) return;
                    if (dateRange.end && date > dateRange.end) return;
                    
                    Object.values(sessions).forEach(record => {
                        Object.entries(record).forEach(([name, status]) => {
                            if (!summary[name]) {
                                summary[name] = { Present: 0, Absent: 0, Permission: 0 };
                            }
                            if (summary[name][status] !== undefined) {
                                summary[name][status]++;
                            } else if (status === 'Permission') {
                                summary[name].Permission++;
                                summary[name].Present++; // Permission counts as Present
                            }
                        });
                    });
                });
                
                // Filter students based on search term
                let filteredNames = Object.keys(summary);
                if (searchTerm) {
                    filteredNames = filteredNames.filter(name => 
                        name.toLowerCase().includes(searchTerm.toLowerCase())
                    );
                }
                
                if (filteredNames.length === 0) {
                    if (searchTerm) {
                        attendanceSummaryDiv.innerHTML = `<p class="text-sm text-gray-600">No students match your search.</p>`;
                    } else {
                        attendanceSummaryDiv.innerHTML = `<p class="text-sm text-gray-600">No finalized data available for the selected date range.</p>`;
                    }
                    return;
                }
                
                // Add date range info
                const rangeInfo = document.createElement('div');
                rangeInfo.className = 'text-sm text-gray-600 mb-4 bg-blue-50 p-3 rounded-lg';
                rangeInfo.innerHTML = `Showing data from <strong>${dateRange.start}</strong> to <strong>${dateRange.end}</strong>`;
                if (searchTerm) {
                    rangeInfo.innerHTML += ` • Filtered by: <strong>${searchTerm}</strong>`;
                }
                attendanceSummaryDiv.appendChild(rangeInfo);
                
                filteredNames.forEach(name => {
                    const summaryDiv = document.createElement('div');
                    summaryDiv.className = 'bg-gray-50 p-4 rounded-xl shadow-sm fade-in';
                    const s = summary[name];
                    const totalDays = s.Present + s.Absent;
                    const attendanceRate = totalDays > 0 ? ((s.Present / totalDays) * 100).toFixed(1) : 0;
                    
                    // Find student gender
                    const student = appData.masterStudents.find(s => s.name === name);
                    const genderTag = student && student.gender === 'male' ? 
                        '<span class="gender-tag male-tag">Male</span>' : 
                        '<span class="gender-tag female-tag">Female</span>';
                    
                    // Highlight search term in student name
                    let displayName = name;
                    if (searchTerm) {
                        const regex = new RegExp(`(${searchTerm})`, 'gi');
                        displayName = name.replace(regex, '<span class="summary-search-highlight">$1</span>');
                    }
                    
                    summaryDiv.innerHTML = `
                        <p class="font-semibold text-lg">${displayName} ${genderTag}</p>
                        <div class="flex justify-between items-center mt-2 text-sm text-gray-700">
                            <span>Present: <span class="font-bold text-green-500">${s.Present}</span></span>
                            <span>Permission: <span class="font-bold text-yellow-500">${s.Permission}</span></span>
                            <span>Absent: <span class="font-bold text-red-500">${s.Absent}</span></span>
                            <span>Rate: <span class="font-bold ${attendanceRate >= 80 ? 'text-green-500' : 'text-red-500'}">${attendanceRate}%</span></span>
                        </div>
                    `;
                    attendanceSummaryDiv.appendChild(summaryDiv);
                });
            } catch (error) {
                console.error('Error in renderSummary:', error);
                attendanceSummaryDiv.innerHTML = 
                    `<div class="error-message">
                        <p>Error generating summary</p>
                    </div>`;
            }
        }

        function renderCompleteHistory() {
            try {
                // Clear previous table content
                completeHistoryTable.querySelector('thead tr').innerHTML = '<th>Student</th>';
                completeHistoryTable.querySelector('tbody').innerHTML = '';
                
                if (Object.keys(appData.finalizedRecords).length === 0) {
                    detailedHistoryView.innerHTML = '<p class="text-sm text-gray-600">No finalized data available.</p>';
                    return;
                }
                
                // Collect all unique dates with sessions
                const dateSessions = [];
                Object.entries(appData.finalizedRecords).forEach(([date, sessions]) => {
                    Object.keys(sessions).forEach(session => {
                        dateSessions.push({ date, session });
                    });
                });
                
                // Sort by date then session
                dateSessions.sort((a, b) => {
                    if (a.date === b.date) {
                        const sessionOrder = { morning: 1, afternoon: 2, evening: 3 };
                        return (sessionOrder[a.session] || 99) - (sessionOrder[b.session] || 99);
                    }
                    return a.date.localeCompare(b.date);
                });
                
                // Add date-session columns to header
                dateSessions.forEach(({ date, session }) => {
                    const th = document.createElement('th');
                    th.textContent = `${date}\n${session}`;
                    th.className = 'text-center';
                    th.style.whiteSpace = 'pre-line';
                    completeHistoryTable.querySelector('thead tr').appendChild(th);
                });
                
                // Add student rows
                appData.masterStudents.forEach(student => {
                    const row = document.createElement('tr');
                    const nameCell = document.createElement('td');
                    nameCell.textContent = student.name;
                    nameCell.className = 'font-semibold';
                    row.appendChild(nameCell);
                    
                    // Add attendance data for each date-session
                    dateSessions.forEach(({ date, session }) => {
                        const cell = document.createElement('td');
                        const status = appData.finalizedRecords[date][session][student.name] || 'Absent';
                        
                        if (status === 'Permission') {
                            cell.textContent = 'PER';
                            cell.className = 'permission-cell';
                        } else if (status === 'Present') {
                            cell.textContent = 'P';
                            cell.className = 'present-cell';
                        } else {
                            cell.textContent = 'A';
                            cell.className = 'absent-cell';
                        }
                        
                        cell.title = `${date} - ${session}: ${status}`;
                        row.appendChild(cell);
                    });
                    
                    completeHistoryTable.querySelector('tbody').appendChild(row);
                });
            } catch (error) {
                console.error('Error in renderCompleteHistory:', error);
                detailedHistoryView.innerHTML = 
                    `<div class="error-message">
                        <p>Error loading history data</p>
                    </div>`;
            }
        }

        function renderDateHistoryList() {
            try {
                dateHistoryListDiv.innerHTML = '';
                const dates = Object.keys(appData.finalizedRecords);
                
                if (dates.length === 0) {
                    dateHistoryListDiv.innerHTML = `<p class="text-sm text-gray-600">No finalized attendance history available.</p>`;
                    return;
                }
                
                // Sort dates in descending order (newest first)
                dates.sort((a, b) => new Date(b) - new Date(a));
                
                dates.forEach(date => {
                    const sessions = Object.keys(appData.finalizedRecords[date]);
                    const dateItem = document.createElement('div');
                    dateItem.className = 'date-history-item w-full p-3 rounded-lg bg-gray-200 text-gray-900 font-semibold hover:bg-indigo-200 transition duration-300 fade-in';
                    
                    dateItem.innerHTML = `
                        <button data-date="${date}" class="history-date-btn text-left flex-grow">${date} (${sessions.length} session${sessions.length > 1 ? 's' : ''})</button>
                        <div class="action-buttons">
                            <button data-date="${date}" class="view-excel-btn excel-btn text-white font-bold py-1 px-3 rounded-lg text-sm transition duration-300">Excel</button>
                            <button data-date="${date}" class="delete-date-btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-sm transition duration-300">Delete</button>
                        </div>
                    `;
                    dateHistoryListDiv.appendChild(dateItem);
                });
            } catch (error) {
                console.error('Error in renderDateHistoryList:', error);
                dateHistoryListDiv.innerHTML = 
                    `<div class="error-message">
                        <p>Error loading date history</p>
                    </div>`;
            }
        }

        function showDateDetailView(date) {
            try {
                if (!appData.finalizedRecords[date]) return;
                
                currentHistoryDate = date;
                const sessions = appData.finalizedRecords[date];
                historyDateTitle.textContent = `Attendance for ${date}`;
                historyDetailContainer.innerHTML = '';
                
                Object.entries(sessions).forEach(([session, data]) => {
                    const sessionHeader = document.createElement('div');
                    sessionHeader.className = 'text-lg font-bold text-indigo-600 mt-4 mb-2';
                    sessionHeader.textContent = `Session: ${session.charAt(0).toUpperCase() + session.slice(1)}`;
                    historyDetailContainer.appendChild(sessionHeader);
                    
                    Object.entries(data).sort().forEach(([name, status]) => {
                        const student = appData.masterStudents.find(s => s.name === name);
                        const genderTag = student && student.gender === 'male' ? 
                            '<span class="gender-tag male-tag">Male</span>' : 
                            '<span class="gender-tag female-tag">Female</span>';
                        
                        const detailDiv = document.createElement('div');
                        detailDiv.className = 'flex items-center justify-between p-2 bg-gray-100 rounded-lg fade-in';
                        
                        if (status === 'Permission') {
                            detailDiv.innerHTML = `
                                <div>
                                    <span class="font-medium">${name}</span>
                                    ${genderTag}
                                    <span class="permission-badge ml-2">Permission</span>
                                </div>
                                <span class="status-icon permission-cell">P</span>
                            `;
                        } else if (status === 'Present') {
                            detailDiv.innerHTML = `
                                <div>
                                    <span class="font-medium">${name}</span>
                                    ${genderTag}
                                </div>
                                <span class="status-icon present-icon">✔️</span>
                            `;
                        } else {
                            detailDiv.innerHTML = `
                                <div>
                                    <span class="font-medium">${name}</span>
                                    ${genderTag}
                                </div>
                                <span class="status-icon absent-icon">✖️</span>
                            `;
                        }
                        
                        historyDetailContainer.appendChild(detailDiv);
                    });
                });

                dateHistoryListDiv.classList.add('hidden');
                dateDetailView.classList.remove('hidden');
            } catch (error) {
                console.error('Error in showDateDetailView:', error);
                alert('Error loading date details');
            }
        }

        // Check for absence alerts (10+ absences in last 3 months)
        function checkAbsenceAlerts() {
            try {
                absenceAlertsList.innerHTML = '';
                
                // Calculate 3 months ago date
                const threeMonthsAgo = new Date();
                threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
                const threeMonthsAgoStr = threeMonthsAgo.toISOString().split('T')[0];
                
                const alerts = [];
                
                // Calculate absences for each student in the last 3 months
                appData.masterStudents.forEach(student => {
                    let absences = 0;
                    const absentDates = [];
                    
                    Object.entries(appData.finalizedRecords).forEach(([date, sessions]) => {
                        // Only count dates within the last 3 months
                        if (date >= threeMonthsAgoStr) {
                            Object.values(sessions).forEach(record => {
                                if (record[student.name] === 'Absent') {
                                    absences++;
                                    absentDates.push(date);
                                }
                            });
                        }
                    });
                    
                    if (absences >= 10) {
                        alerts.push({ student: student.name, absences, absentDates });
                    }
                });
                
                if (alerts.length === 0) {
                    absenceAlertsList.innerHTML = '<p class="text-green-600 font-medium">No students with excessive absences.</p>';
                    absenceAlertsContainer.classList.remove('bg-red-50', 'border-red-200');
                    absenceAlertsContainer.classList.add('bg-green-50', 'border-green-200');
                    return 0;
                }
                
                // Sort by most absences first
                alerts.sort((a, b) => b.absences - a.absences);
                
                alerts.forEach(alert => {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert-student p-3 rounded-lg fade-in';
                    
                    // Format absent dates for display
                    const formattedDates = alert.absentDates.map(date => {
                        return `<span class="absence-date">${date}</span>`;
                    }).join('');
                    
                    alertDiv.innerHTML = `
                        <div class="flex justify-between items-center">
                            <span class="font-medium">${alert.student}</span>
                            <div class="flex items-center gap-2">
                                <span class="bg-red-100 text-red-800 text-sm font-semibold px-2.5 py-0.5 rounded">
                                    ${alert.absences} absences
                                </span>
                                <button data-student-name="${alert.student}" class="dismiss-alert-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-1 px-2 rounded text-xs transition duration-300">
                                    Dismiss
                                </button>
                            </div>
                        </div>
                        <div class="alert-details">
                            <p class="text-sm text-red-700 mb-1">Absent on these dates:</p>
                            <div class="absence-dates">
                                ${formattedDates}
                            </div>
                        </div>
                    `;
                    absenceAlertsList.appendChild(alertDiv);
                });
                
                return alerts.length;
            } catch (error) {
                console.error('Error in checkAbsenceAlerts:', error);
                return 0;
            }
        }
        
        function updateAdminAlertBadge() {
            try {
                const alertCount = checkAbsenceAlerts();
                if (alertCount > 0) {
                    adminAlertBadge.textContent = alertCount;
                    adminAlertBadge.classList.remove('hidden');
                } else {
                    adminAlertBadge.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error in updateAdminAlertBadge:', error);
            }
        }

        // Permission management functions
        function hasPermissionOnDate(studentName, date) {
            try {
                if (!appData.permissions[studentName]) return false;
                return appData.permissions[studentName].some(p => p.date === date);
            } catch (error) {
                console.error('Error in hasPermissionOnDate:', error);
                return false;
            }
        }

        function getMonthlyPermissionCount(studentName, date) {
            try {
                if (!appData.permissions[studentName]) return 0;
                
                // Extract month and year from date
                const dateObj = new Date(date);
                const monthYear = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}`;
                
                return appData.permissions[studentName].filter(p => p.monthYear === monthYear).length;
            } catch (error) {
                console.error('Error in getMonthlyPermissionCount:', error);
                return 0;
            }
        }

        function addPermission(studentName, permissionDate, reason = '') {
            try {
                if (!appData.permissions[studentName]) {
                    appData.permissions[studentName] = [];
                }
                
                // Check monthly limit
                if (getMonthlyPermissionCount(studentName, permissionDate) >= 3) {
                    alert('This student already has 3 permissions this month!');
                    return false;
                }
                
                // Check if permission already exists for this date
                if (hasPermissionOnDate(studentName, permissionDate)) {
                    alert('This student already has permission for this date!');
                    return false;
                }
                
                // Extract month and year for tracking
                const dateObj = new Date(permissionDate);
                const monthYear = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}`;
                
                appData.permissions[studentName].push({
                    date: permissionDate,
                    reason: reason,
                    monthYear: monthYear,
                    addedDate: new Date().toISOString().split('T')[0]
                });
                
                localStorage.setItem('attendanceData', JSON.stringify(appData));
                updatePermissionList();
                renderDailyStudents(datePicker.value, studentSearchInput.value);
                return true;
            } catch (error) {
                console.error('Error in addPermission:', error);
                alert('Error adding permission');
                return false;
            }
        }

        function removePermission(studentName, date) {
            try {
                if (!appData.permissions[studentName]) return;
                
                appData.permissions[studentName] = appData.permissions[studentName].filter(
                    p => p.date !== date
                );
                
                // If no more permissions, remove the student entry
                if (appData.permissions[studentName].length === 0) {
                    delete appData.permissions[studentName];
                }
                
                localStorage.setItem('attendanceData', JSON.stringify(appData));
                updatePermissionList();
                renderDailyStudents(datePicker.value, studentSearchInput.value);
            } catch (error) {
                console.error('Error in removePermission:', error);
                alert('Error removing permission');
            }
        }

        function updatePermissionList() {
            try {
                permissionListDiv.innerHTML = '';
                
                // Populate student select
                permissionStudentSelect.innerHTML = '<option value="">Select Student</option>';
                appData.masterStudents.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.name;
                    option.textContent = student.name;
                    permissionStudentSelect.appendChild(option);
                });
                
                // Display active permissions
                let hasPermissions = false;
                
                Object.entries(appData.permissions).forEach(([studentName, permissions]) => {
                    permissions.forEach(permission => {
                        hasPermissions = true;
                        const permissionDiv = document.createElement('div');
                        permissionDiv.className = 'flex justify-between items-center p-2 bg-yellow-50 rounded-lg';
                        
                        permissionDiv.innerHTML = `
                            <div>
                                <span class="font-medium">${studentName}</span>
                                <span class="text-sm text-gray-600"> - ${permission.date}</span>
                                ${permission.reason ? `<br><span class="text-xs text-gray-500">Reason: ${permission.reason}</span>` : ''}
                            </div>
                            <button data-student="${studentName}" data-date="${permission.date}" class="remove-permission-admin-btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-sm">
                                Remove
                            </button>
                        `;
                        
                        permissionListDiv.appendChild(permissionDiv);
                    });
                });
                
                if (!hasPermissions) {
                    permissionListDiv.innerHTML = '<p class="text-sm text-gray-600">No active permissions.</p>';
                }
            } catch (error) {
                console.error('Error in updatePermissionList:', error);
                permissionListDiv.innerHTML = 
                    `<div class="error-message">
                        <p>Error loading permissions</p>
                    </div>`;
            }
        }

        // Session management
        function setSession(session) {
            try {
                currentSession = session;
                
                // Update session buttons
                [sessionMorningBtn, sessionAfternoonBtn, sessionEveningBtn].forEach(btn => {
                    btn.classList.remove('active');
                });
                
                const sessionText = session.charAt(0).toUpperCase() + session.slice(1);
                sessionIndicator.textContent = `Session: ${sessionText}`;
                
                if (session === 'morning') {
                    sessionMorningBtn.classList.add('active');
                } else if (session === 'afternoon') {
                    sessionAfternoonBtn.classList.add('active');
                } else if (session === 'evening') {
                    sessionEveningBtn.classList.add('active');
                }
                
                renderDailyStudents(datePicker.value, studentSearchInput.value);
            } catch (error) {
                console.error('Error in setSession:', error);
            }
        }

        // Action functions
        function addMasterStudent() {
            try {
                const studentName = newStudentNameInput.value.trim();
                const studentGender = newStudentGenderSelect.value;
                
                if (!studentName) {
                    alert("Please enter a student name.");
                    return;
                }

                if (appData.masterStudents.some(student => student.name === studentName)) {
                    alert("Student with this name already exists.");
                    newStudentNameInput.value = '';
                    return;
                }

                appData.masterStudents.push({name: studentName, gender: studentGender});
                newStudentNameInput.value = '';
                
                // Save to localStorage and re-render
                localStorage.setItem('attendanceData', JSON.stringify(appData));
                renderMasterStudents();
                setupDailyAttendanceListener();
                updatePermissionList();
                
                // Show success message
                setTimeout(() => {
                    const successMsg = document.createElement('div');
                    successMsg.className = 'text-green-600 text-sm mt-2';
                    successMsg.textContent = 'Student added successfully!';
                    masterStudentListDiv.parentNode.insertBefore(successMsg, masterStudentListDiv.nextSibling);
                    setTimeout(() => successMsg.remove(), 3000);
                }, 100);
            } catch (error) {
                console.error('Error in addMasterStudent:', error);
                alert('Error adding student');
            }
        }

        function removeMasterStudent(studentName) {
            try {
                if (!confirm(`Are you sure you want to remove ${studentName}? This will also remove all their attendance records.`)) {
                    return;
                }
                
                appData.masterStudents = appData.masterStudents.filter(student => student.name !== studentName);
                
                // Also remove from all attendance records
                Object.keys(appData.sessions).forEach(date => {
                    Object.keys(appData.sessions[date]).forEach(session => {
                        if (appData.sessions[date][session][studentName]) {
                            delete appData.sessions[date][session][studentName];
                        }
                    });
                });
                
                // Remove from finalized records
                Object.keys(appData.finalizedRecords).forEach(date => {
                    Object.keys(appData.finalizedRecords[date]).forEach(session => {
                        if (appData.finalizedRecords[date][session][studentName]) {
                            delete appData.finalizedRecords[date][session][studentName];
                        }
                    });
                });
                
                // Remove permissions
                if (appData.permissions[studentName]) {
                    delete appData.permissions[studentName];
                }
                
                // Save to localStorage and re-render
                localStorage.setItem('attendanceData', JSON.stringify(appData));
                renderMasterStudents();
                setupDailyAttendanceListener();
                renderSummary(summarySearchInput.value);
                updateAdminAlertBadge();
                updatePermissionList();
                
                alert(`Student "${studentName}" removed successfully.`);
            } catch (error) {
                console.error('Error in removeMasterStudent:', error);
                alert('Error removing student');
            }
        }

        function editStudent(studentName) {
            try {
                const student = appData.masterStudents.find(s => s.name === studentName);
                if (!student) return;
                
                currentEditStudent = studentName;
                editStudentNameInput.value = student.name;
                editStudentGenderSelect.value = student.gender;
                editStudentModal.classList.remove('hidden');
            } catch (error) {
                console.error('Error in editStudent:', error);
                alert('Error opening edit modal');
            }
        }

        function saveStudentEdit() {
            try {
                if (!currentEditStudent) return;
                
                const newName = editStudentNameInput.value.trim();
                const newGender = editStudentGenderSelect.value;
                
                if (!newName) {
                    alert("Student name cannot be empty.");
                    return;
                }
                
                // Check if the new name already exists (excluding the current student)
                if (appData.masterStudents.some(student => student.name === newName && student.name !== currentEditStudent)) {
                    alert("Another student with this name already exists.");
                    return;
                }
                
                // Update the student in the master list
                const studentIndex = appData.masterStudents.findIndex(s => s.name === currentEditStudent);
                if (studentIndex !== -1) {
                    appData.masterStudents[studentIndex].name = newName;
                    appData.masterStudents[studentIndex].gender = newGender;
                    
                    // Update all session records with the new name
                    Object.keys(appData.sessions).forEach(date => {
                        Object.keys(appData.sessions[date]).forEach(session => {
                            if (appData.sessions[date][session][currentEditStudent] !== undefined) {
                                appData.sessions[date][session][newName] = appData.sessions[date][session][currentEditStudent];
                                delete appData.sessions[date][session][currentEditStudent];
                            }
                        });
                    });
                    
                    // Update all finalized records with the new name
                    Object.keys(appData.finalizedRecords).forEach(date => {
                        Object.keys(appData.finalizedRecords[date]).forEach(session => {
                            if (appData.finalizedRecords[date][session][currentEditStudent] !== undefined) {
                                appData.finalizedRecords[date][session][newName] = appData.finalizedRecords[date][session][currentEditStudent];
                                delete appData.finalizedRecords[date][session][currentEditStudent];
                            }
                        });
                    });
                    
                    // Update permissions
                    if (appData.permissions[currentEditStudent]) {
                        appData.permissions[newName] = appData.permissions[currentEditStudent];
                        delete appData.permissions[currentEditStudent];
                    }
                }
                
                // Save to localStorage and re-render
                localStorage.setItem('attendanceData', JSON.stringify(appData));
                renderMasterStudents();
                setupDailyAttendanceListener();
                renderSummary(summarySearchInput.value);
                updateAdminAlertBadge();
                updatePermissionList();
                
                // Close the modal
                editStudentModal.classList.add('hidden');
                currentEditStudent = null;
                
                alert('Student updated successfully!');
            } catch (error) {
                console.error('Error in saveStudentEdit:', error);
                alert('Error saving student changes');
            }
        }

        function updateStatus(studentName, status) {
            try {
                const selectedDate = datePicker.value;
                
                if (!appData.sessions[selectedDate]) {
                    appData.sessions[selectedDate] = {};
                }
                if (!appData.sessions[selectedDate][currentSession]) {
                    appData.sessions[selectedDate][currentSession] = {};
                }
                
                appData.sessions[selectedDate][currentSession][studentName] = status;
                
                // Save to localStorage and re-render
                localStorage.setItem('attendanceData', JSON.stringify(appData));
                
                // Re-render with current search term
                renderDailyStudents(selectedDate, studentSearchInput.value);
            } catch (error) {
                console.error('Error in updateStatus:', error);
                alert('Error updating status');
            }
        }

        function finalizeAndExport() {
            try {
                if (appData.masterStudents.length === 0) {
                    exportMessageDiv.textContent = "Cannot save empty attendance data.";
                    exportMessageDiv.className = "text-center text-sm my-2 text-red-600";
                    return;
                }
                
                exportMessageDiv.textContent = "Saving...";
                exportMessageDiv.className = "text-center text-sm my-2 text-blue-600";
                
                const selectedDate = datePicker.value;
                
                if (!appData.sessions[selectedDate]) {
                    appData.sessions[selectedDate] = {};
                }
                if (!appData.sessions[selectedDate][currentSession]) {
                    appData.sessions[selectedDate][currentSession] = {};
                }
                
                // Create finalized record
                const dataToSave = {};
                appData.masterStudents.forEach(student => {
                    // Check for permission first
                    if (hasPermissionOnDate(student.name, selectedDate)) {
                        dataToSave[student.name] = 'Permission';
                    } else {
                        dataToSave[student.name] = appData.sessions[selectedDate][currentSession][student.name] || 'Absent';
                    }
                });
                
                // Save with session identifier
                if (!appData.finalizedRecords[selectedDate]) {
                    appData.finalizedRecords[selectedDate] = {};
                }
                appData.finalizedRecords[selectedDate][currentSession] = dataToSave;
                
                localStorage.setItem('attendanceData', JSON.stringify(appData));
                
                exportMessageDiv.textContent = `Attendance for ${selectedDate} (${currentSession}) saved successfully!`;
                exportMessageDiv.className = "text-center text-sm my-2 text-green-600";
                
                renderSummary(summarySearchInput.value);
                renderDateHistoryList();
                updateAdminAlertBadge();
                
                setTimeout(() => {
                    exportMessageDiv.textContent = "";
                    exportMessageDiv.className = "text-center text-sm my-2 text-gray-600";
                }, 3000);
            } catch (error) {
                console.error('Error in finalizeAndExport:', error);
                exportMessageDiv.textContent = "Error saving attendance data.";
                exportMessageDiv.className = "text-center text-sm my-2 text-red-600";
            }
        }

        function saveHistoryAsExcel() {
            try {
                if (!currentHistoryDate) return;
                
                if (typeof XLSX === 'undefined') {
                    alert('Excel library not loaded. Please check your internet connection.');
                    return;
                }
                
                const sessions = appData.finalizedRecords[currentHistoryDate];
                const allData = [];
                
                Object.entries(sessions).forEach(([session, data]) => {
                    // Add session header
                    allData.push([`Session: ${session.charAt(0).toUpperCase() + session.slice(1)}`]);
                    allData.push(['Student Name', 'Gender', 'Status']);
                    
                    Object.entries(data).sort().forEach(([name, status]) => {
                        // Find student gender
                        const student = appData.masterStudents.find(s => s.name === name);
                        const gender = student ? student.gender : 'Unknown';
                        
                        allData.push([name, gender, status]);
                    });
                    
                    // Add empty row between sessions
                    allData.push([]);
                });
                
                // Remove last empty row if exists
                if (allData[allData.length - 1].length === 0) {
                    allData.pop();
                }
                
                // Create worksheet
                const ws = XLSX.utils.aoa_to_sheet(allData);
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Attendance');
                
                // Export to Excel
                XLSX.writeFile(wb, `Attendance_${currentHistoryDate}.xlsx`);
            } catch (error) {
                console.error('Error in saveHistoryAsExcel:', error);
                alert('Error exporting to Excel');
            }
        }

        function saveCompleteHistoryAsExcel() {
            try {
                if (Object.keys(appData.finalizedRecords).length === 0) {
                    alert('No finalized data available to export.');
                    return;
                }
                
                if (typeof XLSX === 'undefined') {
                    alert('Excel library not loaded. Please check your internet connection.');
                    return;
                }
                
                // Get all dates and sort them
                const dateSessions = [];
                Object.entries(appData.finalizedRecords).forEach(([date, sessions]) => {
                    Object.keys(sessions).forEach(session => {
                        dateSessions.push({ date, session });
                    });
                });
                
                // Sort by date then session
                dateSessions.sort((a, b) => {
                    if (a.date === b.date) {
                        const sessionOrder = { morning: 1, afternoon: 2, evening: 3 };
                        return (sessionOrder[a.session] || 99) - (sessionOrder[b.session] || 99);
                    }
                    return a.date.localeCompare(b.date);
                });
                
                // Prepare data for Excel
                const excelData = [['Student', 'Gender', ...dateSessions.map(ds => `${ds.date}\n${ds.session}`)]];
                
                // Add student rows
                appData.masterStudents.forEach(student => {
                    const row = [student.name, student.gender];
                    
                    // Add attendance data for each date-session
                    dateSessions.forEach(({ date, session }) => {
                        const status = appData.finalizedRecords[date][session][student.name] || 'Absent';
                        row.push(status === 'Permission' ? 'PER' : (status === 'Present' ? 'P' : 'A'));
                    });
                    
                    excelData.push(row);
                });
                
                // Create worksheet
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Attendance History');
                
                // Export to Excel
                XLSX.writeFile(wb, `Complete_Attendance_History.xlsx`);
            } catch (error) {
                console.error('Error in saveCompleteHistoryAsExcel:', error);
                alert('Error exporting to Excel');
            }
        }

        function saveSummaryAsPdf() {
            try {
                if (typeof window.jspdf === 'undefined') {
                    alert('PDF library not loaded. Please check your internet connection.');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                
                // Create a new PDF document
                const doc = new jsPDF();
                
                // First, let's try with the default font for English headers
                doc.setFontSize(22);
                doc.text('Attendance Summary', 14, 22);
                
                // Add date information
                const date = new Date().toLocaleDateString();
                doc.setFontSize(12);
                doc.text(`Generated on: ${date}`, 14, 32);
                
                // Add date range info
                doc.text(`Date Range: ${dateRange.start} to ${dateRange.end}`, 14, 42);
                
                // Add search term if applicable
                if (summarySearchInput.value) {
                    doc.text(`Filtered by: ${summarySearchInput.value}`, 14, 52);
                }
                
                // Prepare summary data
                const summary = {};
                
                // Calculate summary from finalized records within date range
                Object.entries(appData.finalizedRecords).forEach(([date, sessions]) => {
                    // Skip dates outside the selected range
                    if (dateRange.start && date < dateRange.start) return;
                    if (dateRange.end && date > dateRange.end) return;
                    
                    Object.values(sessions).forEach(record => {
                        Object.entries(record).forEach(([name, status]) => {
                            if (!summary[name]) {
                                summary[name] = { Present: 0, Absent: 0, Permission: 0 };
                            }
                            if (status === 'Permission') {
                                summary[name].Permission++;
                                summary[name].Present++;
                            } else if (summary[name][status] !== undefined) {
                                summary[name][status]++;
                            }
                        });
                    });
                });
                
                // Filter by search term if applicable
                let filteredNames = Object.keys(summary);
                if (summarySearchInput.value) {
                    filteredNames = filteredNames.filter(name => 
                        name.toLowerCase().includes(summarySearchInput.value.toLowerCase())
                    );
                }
                
                // Sort names
                filteredNames.sort();
                
                // We'll create a CSV format first since PDF Amharic support is tricky
                // Then offer both options
                
                // Create CSV content
                const csvContent = [
                    ['Student', 'Gender', 'Present', 'Permission', 'Absent', 'Rate'],
                    ...filteredNames.map(name => {
                        const s = summary[name];
                        const totalDays = s.Present + s.Absent;
                        const attendanceRate = totalDays > 0 ? ((s.Present / totalDays) * 100).toFixed(1) : 0;
                        
                        // Find student gender
                        const student = appData.masterStudents.find(s => s.name === name);
                        const gender = student ? student.gender : 'Unknown';
                        
                        return [name, gender, s.Present, s.Permission, s.Absent, `${attendanceRate}%`];
                    })
                ];
                
                // Convert to CSV string
                const csvString = csvContent.map(row => 
                    row.map(cell => `"${cell}"`).join(',')
                ).join('\n');
                
                // Create a Blob and download as CSV (better for Amharic)
                const csvBlob = new Blob(['\ufeff' + csvString], { type: 'text/csv;charset=utf-8;' });
                const csvUrl = URL.createObjectURL(csvBlob);
                
                // Create Excel data for better Amharic support
                const excelData = [
                    ['Attendance Summary'],
                    [`Generated on: ${date}`],
                    [`Date Range: ${dateRange.start} to ${dateRange.end}`],
                    ...(summarySearchInput.value ? [`Filtered by: ${summarySearchInput.value}`] : []),
                    [],
                    ['Student', 'Gender', 'Present', 'Permission', 'Absent', 'Attendance Rate (%)']
                ];
                
                // Add student data
                filteredNames.forEach(name => {
                    const s = summary[name];
                    const totalDays = s.Present + s.Absent;
                    const attendanceRate = totalDays > 0 ? ((s.Present / totalDays) * 100).toFixed(1) : 0;
                    
                    const student = appData.masterStudents.find(s => s.name === name);
                    const gender = student ? student.gender : 'Unknown';
                    
                    excelData.push([name, gender, s.Present, s.Permission, s.Absent, attendanceRate]);
                });
                
                // Ask user which format they prefer
                const userChoice = confirm(
                    "For Amharic characters:\n" +
                    "• Click OK for Excel (recommended - supports Amharic)\n" +
                    "• Click Cancel for PDF (limited Amharic support)"
                );
                
                if (userChoice && typeof XLSX !== 'undefined') {
                    // Export to Excel (better Amharic support)
                    const ws = XLSX.utils.aoa_to_sheet(excelData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Attendance Summary');
                    
                    // Create filename with date
                    const today = new Date().toISOString().split('T')[0];
                    const fileName = summarySearchInput.value 
                        ? `Attendance_Summary_${summarySearchInput.value}_${today}.xlsx`
                        : `Attendance_Summary_${today}.xlsx`;
                    
                    XLSX.writeFile(wb, fileName);
                } else {
                    // Continue with PDF (limited Amharic)
                    let yPosition = summarySearchInput.value ? 62 : 55;
                    
                    // Add table headers to PDF
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('Student', 14, yPosition);
                    doc.text('Gender', 70, yPosition);
                    doc.text('Present', 100, yPosition);
                    doc.text('Permission', 130, yPosition);
                    doc.text('Absent', 160, yPosition);
                    doc.text('Rate', 190, yPosition);
                    yPosition += 8;
                    
                    // Add a line separator
                    doc.line(14, yPosition, 200, yPosition);
                    yPosition += 10;
                    
                    // Add student data to PDF (Amharic names will appear as placeholders or garbled)
                    doc.setFont(undefined, 'normal');
                    filteredNames.forEach(name => {
                        const s = summary[name];
                        const totalDays = s.Present + s.Absent;
                        const attendanceRate = totalDays > 0 ? ((s.Present / totalDays) * 100).toFixed(1) : 0;
                        
                        // Find student gender
                        const student = appData.masterStudents.find(s => s.name === name);
                        const gender = student ? student.gender : 'Unknown';
                        
                        if (yPosition > 270) {
                            doc.addPage();
                            yPosition = 20;
                        }
                        
                        // Try to display Amharic names (may appear garbled)
                        const displayName = name.length > 20 ? name.substring(0, 20) + '...' : name;
                        doc.text(displayName, 14, yPosition);
                        doc.text(gender, 70, yPosition);
                        doc.text(s.Present.toString(), 100, yPosition);
                        doc.text(s.Permission.toString(), 130, yPosition);
                        doc.text(s.Absent.toString(), 160, yPosition);
                        doc.text(`${attendanceRate}%`, 190, yPosition);
                        
                        yPosition += 8;
                    });
                    
                    // Add totals if there's space
                    if (yPosition < 270) {
                        yPosition += 10;
                        doc.line(14, yPosition, 200, yPosition);
                        yPosition += 8;
                        
                        doc.setFont(undefined, 'bold');
                        const totalPresent = filteredNames.reduce((acc, name) => acc + summary[name].Present, 0);
                        const totalPermission = filteredNames.reduce((acc, name) => acc + summary[name].Permission, 0);
                        const totalAbsent = filteredNames.reduce((acc, name) => acc + summary[name].Absent, 0);
                        const totalDays = totalPresent + totalAbsent;
                        const overallRate = totalDays > 0 ? ((totalPresent / totalDays) * 100).toFixed(1) : 0;
                        
                        doc.text('TOTALS:', 14, yPosition);
                        doc.text('', 70, yPosition);
                        doc.text(totalPresent.toString(), 100, yPosition);
                        doc.text(totalPermission.toString(), 130, yPosition);
                        doc.text(totalAbsent.toString(), 160, yPosition);
                        doc.text(`${overallRate}%`, 190, yPosition);
                    }
                    
                    const today = new Date().toISOString().split('T')[0];
                    const fileName = summarySearchInput.value 
                        ? `Attendance_Summary_${summarySearchInput.value}_${today}.pdf`
                        : `Attendance_Summary_${today}.pdf`;
                    
                    // Add a note about Amharic characters
                    doc.setFontSize(10);
                    doc.text('Note: For proper Amharic character display, please use the Excel export option.', 14, 280);
                    
                    doc.save(fileName);
                    
                    // Also download CSV as backup
                    const downloadLink = document.createElement('a');
                    downloadLink.href = csvUrl;
                    downloadLink.download = `Attendance_Summary_${today}.csv`;
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    
                    alert("PDF downloaded! For better Amharic support, a CSV file was also downloaded.");
                }
            } catch (error) {
                console.error('Error in saveSummaryAsPdf:', error);
                alert('Error generating PDF/Excel');
            }
        }
        
        function resetAllData() {
            try {
                // Reset all data to default
                const defaultData = {
                    masterStudents: [],
                    attendanceRecords: {},
                    finalizedRecords: {},
                    permissions: {},
                    sessions: {},
                    users: [
                        {username: "admin", password: "0730", role: "admin"},
                        {username: "user", password: "1234", role: "user"}
                    ]
                };
                
                localStorage.setItem('attendanceData', JSON.stringify(defaultData));
                appData = defaultData;
                
                // Re-render all components
                renderMasterStudents();
                setupDailyAttendanceListener();
                renderSummary(summarySearchInput.value);
                renderDateHistoryList();
                updateAdminAlertBadge();
                updatePermissionList();
                setSession('morning');
                
                // Show success message
                alert("All data has been reset successfully!");
            } catch (error) {
                console.error('Error in resetAllData:', error);
                alert('Error resetting data');
            }
        }
        
        function deleteDateAttendance(date) {
            try {
                if (appData.finalizedRecords[date]) {
                    delete appData.finalizedRecords[date];
                }
                
                if (appData.sessions[date]) {
                    delete appData.sessions[date];
                }
                
                // Save to localStorage
                localStorage.setItem('attendanceData', JSON.stringify(appData));
                
                // Re-render components
                renderSummary(summarySearchInput.value);
                renderDateHistoryList();
                updateAdminAlertBadge();
                
                // Show success message
                alert(`Attendance data for ${date} has been deleted successfully!`);
            } catch (error) {
                console.error('Error in deleteDateAttendance:', error);
                alert('Error deleting date data');
            }
        }

        function exportDateToExcel(date) {
            try {
                if (typeof XLSX === 'undefined') {
                    alert('Excel library not loaded. Please check your internet connection.');
                    return;
                }
                
                const sessions = appData.finalizedRecords[date];
                const allData = [];
                
                Object.entries(sessions).forEach(([session, data]) => {
                    // Add session header
                    allData.push([`Session: ${session.charAt(0).toUpperCase() + session.slice(1)}`]);
                    allData.push(['Student Name', 'Gender', 'Status']);
                    
                    Object.entries(data).sort().forEach(([name, status]) => {
                        // Find student gender
                        const student = appData.masterStudents.find(s => s.name === name);
                        const gender = student ? student.gender : 'Unknown';
                        
                        allData.push([name, gender, status]);
                    });
                    
                    // Add empty row between sessions
                    allData.push([]);
                });
                
                // Remove last empty row if exists
                if (allData[allData.length - 1].length === 0) {
                    allData.pop();
                }
                
                // Create worksheet
                const ws = XLSX.utils.aoa_to_sheet(allData);
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Attendance');
                
                // Export to Excel
                XLSX.writeFile(wb, `Attendance_${date}.xlsx`);
            } catch (error) {
                console.error('Error in exportDateToExcel:', error);
                alert('Error exporting to Excel');
            }
        }
        
        // Apply date range filter
        function applyDateRange() {
            try {
                dateRange.start = startDateInput.value;
                dateRange.end = endDateInput.value;
                
                if (dateRange.start && dateRange.end && dateRange.start > dateRange.end) {
                    alert("Start date cannot be after end date.");
                    return;
                }
                
                renderSummary(summarySearchInput.value);
            } catch (error) {
                console.error('Error in applyDateRange:', error);
                alert('Error applying date range');
            }
        }

        // Set gender filter
        function setGenderFilter(gender) {
            try {
                currentGenderFilter = gender;
                
                // Update button styles
                allGenderBtn.className = gender === 'all' ? 'gender-btn active' : 'gender-btn inactive';
                maleGenderBtn.className = gender === 'male' ? 'gender-btn active' : 'gender-btn inactive';
                femaleGenderBtn.className = gender === 'female' ? 'gender-btn active' : 'gender-btn inactive';
                
                // Re-render students with the new filter
                const selectedDate = datePicker.value;
                renderDailyStudents(selectedDate, studentSearchInput.value);
            } catch (error) {
                console.error('Error in setGenderFilter:', error);
            }
        }

        // Toggle between summary and detailed history views
        function showSummaryView() {
            summaryView.classList.remove('hidden');
            detailedHistoryView.classList.add('hidden');
            showSummaryViewBtn.classList.add('bg-indigo-700');
            showHistoryViewBtn.classList.remove('bg-purple-700');
        }

        function showHistoryView() {
            summaryView.classList.add('hidden');
            detailedHistoryView.classList.remove('hidden');
            showSummaryViewBtn.classList.remove('bg-indigo-700');
            showHistoryViewBtn.classList.add('bg-purple-700');
            renderCompleteHistory();
        }

        // New function to handle password submission
        function handleAdminPassword() {
            try {
                const password = adminPasswordInput.value;
                const user = appData.users.find(u => u.password === password);
                
                if (user) {
                    showSection('adminSection');
                    passwordMessage.textContent = '';
                    adminPasswordInput.value = '';
                } else {
                    passwordMessage.textContent = 'Incorrect password. Please try again.';
                }
            } catch (error) {
                console.error('Error in handleAdminPassword:', error);
                passwordMessage.textContent = 'Error checking password.';
            }
        }

        // Event listeners
        addStudentBtn.addEventListener('click', addMasterStudent);
        datePicker.addEventListener('change', setupDailyAttendanceListener);
        finalizeButton.addEventListener('click', finalizeAndExport);
        saveExcelBtn.addEventListener('click', saveHistoryAsExcel);
        saveSummaryPdfBtn.addEventListener('click', saveSummaryAsPdf);
        saveHistoryExcelBtn.addEventListener('click', saveCompleteHistoryAsExcel);
        applyDateRangeBtn.addEventListener('click', applyDateRange);
        showSummaryViewBtn.addEventListener('click', showSummaryView);
        showHistoryViewBtn.addEventListener('click', showHistoryView);
        
        // Gender filter buttons
        allGenderBtn.addEventListener('click', () => setGenderFilter('all'));
        maleGenderBtn.addEventListener('click', () => setGenderFilter('male'));
        femaleGenderBtn.addEventListener('click', () => setGenderFilter('female'));
        
        // Summary search functionality
        summarySearchInput.addEventListener('input', () => {
            renderSummary(summarySearchInput.value);
        });
        
        // Reset functionality
        resetSummaryBtn.addEventListener('click', () => {
            resetModal.classList.remove('hidden');
        });
        
        cancelResetBtn.addEventListener('click', () => {
            resetModal.classList.add('hidden');
        });
        
        confirmResetBtn.addEventListener('click', () => {
            resetModal.classList.add('hidden');
            resetAllData();
        });
        
        // Date deletion functionality
        dateHistoryListDiv.addEventListener('click', (event) => {
            const target = event.target;
            if (target.classList.contains('delete-date-btn')) {
                dateToDelete = target.dataset.date;
                deleteDateMessage.textContent = `Are you sure you want to delete attendance data for ${dateToDelete}?`;
                deleteDateModal.classList.remove('hidden');
            } else if (target.classList.contains('history-date-btn')) {
                showDateDetailView(target.dataset.date);
            } else if (target.classList.contains('view-excel-btn')) {
                exportDateToExcel(target.dataset.date);
            }
        });
        
        cancelDeleteBtn.addEventListener('click', () => {
            deleteDateModal.classList.add('hidden');
            dateToDelete = null;
        });
        
        confirmDeleteBtn.addEventListener('click', () => {
            deleteDateModal.classList.add('hidden');
            if (dateToDelete) {
                deleteDateAttendance(dateToDelete);
                dateToDelete = null;
            }
        });
        
        // Student editing functionality
        masterStudentListDiv.addEventListener('click', (event) => {
            const target = event.target;
            if (target.classList.contains('edit-student-btn')) {
                editStudent(target.dataset.studentName);
            } else if (target.classList.contains('remove-btn')) {
                const studentName = target.dataset.studentName;
                if (studentName) {
                    removeMasterStudent(studentName);
                }
            }
        });
        
        cancelEditBtn.addEventListener('click', () => {
            editStudentModal.classList.add('hidden');
            currentEditStudent = null;
        });
        
        saveEditBtn.addEventListener('click', saveStudentEdit);
        
        // Search functionality
        studentSearchInput.addEventListener('input', () => {
            const searchTerm = studentSearchInput.value;
            const selectedDate = datePicker.value;
            renderDailyStudents(selectedDate, searchTerm);
        });
        
        dailyAttendanceContainer.addEventListener('click', (event) => {
            const target = event.target;
            if (target.classList.contains('status-btn')) {
                const studentName = target.dataset.studentName;
                const status = target.dataset.status;
                if (studentName && status) {
                    updateStatus(studentName, status);
                }
            } else if (target.classList.contains('give-permission-btn')) {
                const studentName = target.dataset.studentName;
                if (studentName) {
                    // Check monthly limit
                    const monthlyCount = getMonthlyPermissionCount(studentName, datePicker.value);
                    if (monthlyCount >= 3) {
                        alert('This student already has 3 permissions this month!');
                        return;
                    }
                    
                    currentPermissionStudent = studentName;
                    modalPermissionDateInput.value = datePicker.value;
                    permissionLimitWarningDiv.classList.toggle('hidden', monthlyCount < 3);
                    permissionModal.classList.remove('hidden');
                }
            } else if (target.classList.contains('remove-permission-btn')) {
                const studentName = target.dataset.studentName;
                if (studentName && confirm('Remove permission for this student?')) {
                    removePermission(studentName, datePicker.value);
                }
            }
        });

        // Permission list event listener
        permissionListDiv.addEventListener('click', (event) => {
            const target = event.target;
            if (target.classList.contains('remove-permission-admin-btn')) {
                const studentName = target.dataset.student;
                const permissionDate = target.dataset.date;
                if (studentName && permissionDate) {
                    removePermission(studentName, permissionDate);
                }
            }
        });

        // Dismiss alert functionality
        absenceAlertsList.addEventListener('click', (event) => {
            const target = event.target;
            if (target.classList.contains('dismiss-alert-btn')) {
                target.closest('.alert-student').remove();
                updateAdminAlertBadge();
            }
        });

        closeDateViewBtn.addEventListener('click', () => {
            dateDetailView.classList.add('hidden');
            dateHistoryListDiv.classList.remove('hidden');
            currentHistoryDate = null;
        });

        // Session button event listeners
        sessionMorningBtn.addEventListener('click', () => setSession('morning'));
        sessionAfternoonBtn.addEventListener('click', () => setSession('afternoon'));
        sessionEveningBtn.addEventListener('click', () => setSession('evening'));

        // Permission modal event listeners
        cancelPermissionBtn.addEventListener('click', () => {
            permissionModal.classList.add('hidden');
            currentPermissionStudent = null;
        });

        savePermissionBtn.addEventListener('click', () => {
            if (!currentPermissionStudent) return;
            
            const permissionDate = modalPermissionDateInput.value;
            const reason = permissionReasonInput.value.trim();
            
            if (addPermission(currentPermissionStudent, permissionDate, reason)) {
                permissionModal.classList.add('hidden');
                permissionReasonInput.value = '';
                currentPermissionStudent = null;
            }
        });

        // Add permission from admin panel
        addPermissionBtn.addEventListener('click', () => {
            const studentName = permissionStudentSelect.value;
            const permissionDate = permissionDateInput.value;
            
            if (!studentName) {
                alert('Please select a student');
                return;
            }
            
            if (!permissionDate) {
                alert('Please select a date');
                return;
            }
            
            if (addPermission(studentName, permissionDate)) {
                permissionStudentSelect.value = '';
            }
        });

        // Function to show/hide sections
        function showSection(sectionId) {
            try {
                const allSections = [dailyAttendanceSection, adminSection, adminPasswordSection];
                const allButtons = [showDailyBtn, showAdminBtn];

                allSections.forEach(section => {
                    if (section.id === sectionId) {
                        section.classList.remove('hidden');
                    } else {
                        section.classList.add('hidden');
                    }
                });

                allButtons.forEach(button => {
                    if ((button.id === 'showDailyBtn' && sectionId === 'dailyAttendanceSection') || 
                        (button.id === 'showAdminBtn' && (sectionId === 'adminSection' || sectionId === 'adminPasswordSection'))) {
                        button.classList.remove('bg-gray-500');
                        button.classList.add('bg-indigo-500');
                    } else {
                        button.classList.remove('bg-indigo-500');
                        button.classList.add('bg-gray-500');
                    }
                });
            } catch (error) {
                console.error('Error in showSection:', error);
            }
        }

        showDailyBtn.addEventListener('click', () => showSection('dailyAttendanceSection'));
        showAdminBtn.addEventListener('click', () => showSection('adminPasswordSection'));
        submitPasswordBtn.addEventListener('click', handleAdminPassword);
        adminPasswordInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                handleAdminPassword();
            }
        });

        // Prevent form submission on Enter key in input fields
        newStudentNameInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                addMasterStudent();
            }
        });

        // Initial app load
        window.addEventListener('load', () => {
            console.log('Window loaded, initializing app...');
            initializeApp();
            showSection('dailyAttendanceSection');
            
            // Add some sample students if empty
            if (appData.masterStudents.length === 0) {
                const sampleStudents = [

    {"name": "ኑሀሚን አንድነት", "gender": "female"},
    {"name": "ሳሮን ዳንኤል", "gender": "female"},
    {"name": "አቤኔዘር ይርጋለም", "gender": "male"},
    {"name": "ሜሮን ግርማ", "gender": "female"},
    {"name": "ናፍያድ ቀነኒሳ", "gender": "male"},
    {"name": "ፅናት ወልዱ", "gender": "female"},
    {"name": "ቅድስት ታደሰ", "gender": "female"},
    {"name": "ምህረት ጋሻው", "gender": "female"},
    {"name": "ዮርዳኖስ ታጠቅ", "gender": "female"},
    {"name": "ናታኒም ምትኩ", "gender": "male"},
    {"name": "አቤኔዘር ጥላሁን", "gender": "male"},
    {"name": "ኑሀሚን ታልጌታ", "gender": "female"},
    {"name": "አማኑኤል ቀነኒሳ", "gender": "male"},
    {"name": "ናታን ስዮም", "gender": "male"},
    {"name": "ተመስገን ተ/ብርሀን", "gender": "male"},
    {"name": "ፋኑኤል እንዳልካቸው", "gender": "male"},
    {"name": "ማራናታ ዝናዬ", "gender": "female"},
    {"name": "ማራማዊት ዮናስ", "gender": "female"},
    {"name": "እድላዊት ደስታ", "gender": "female"},
    {"name": "ኤልዳና አበበ", "gender": "male"},
    {"name": "ሜሮን ስዮም", "gender": "female"},
    {"name": "ካሌብ ሐኮንን", "gender": "male"},
    {"name": "ዳዊት እንዳየ", "gender": "male"},
    {"name": "በፀሎት ዘመተ", "gender": "female"},
    {"name": "የአብ ዘር ይድነቃቸው", "gender": "female"},
    {"name": "አቢሲኒያ ፍቃዱ", "gender": "female"},
    {"name": "ሶሊያና ሀይሉ", "gender": "female"},
    {"name": "ህይወት ታሪኩ", "gender": "female"},
    {"name": "በእምነት ከፍያለው", "gender": "female"},
    {"name": "ፍቅር አዲስ", "gender": "male"},
    {"name": "አብርሀም ወንድሜ", "gender": "male"},
    {"name": "መክሊት አራጌ", "gender": "female"},
    {"name": "ምኞት ታደለ", "gender": "female"},
    {"name": "ብሌን ካሳሁን", "gender": "female"},
    {"name": "ኬና ቶሌሳ", "gender": "male"},
    {"name": "ያብስራ ካሳሁን", "gender": "female"},
    {"name": "ናትናኤል ሽመልስ", "gender": "male"},
    {"name": "ሄኖክ ጉልማ", "gender": "male"},
    {"name": "ቃልአብ ቁምላቸው", "gender": "male"},
    {"name": "ኤዶምያስ ዘረፈ", "gender": "male"},
    {"name": "ሱራፊል ምንዳ", "gender": "male"},
    {"name": "አሸናፊ ፍቅሪ", "gender": "male"},
    {"name": "በእምነት አንበሳ", "gender": "male"},
    {"name": "በሱፍቃድ ዘሪሁን", "gender": "male"},
    {"name": "ኪሩቤል ነጋ", "gender": "male"},
    {"name": "በፀሎት ዘመት", "gender": "female"},
    {"name": "መልክኤል እዮብ", "gender": "male"},
    {"name": "ፍሌበር ደረጀ", "gender": "male"},
    {"name": "ህይወት ታሪኩ", "gender": "female"},
    {"name": "ፍቅር አዲስ", "gender": "male"},
    {"name": "ህይወት ተመስገን", "gender": "female"},
    {"name": "ባምላክ አለሜነህ", "gender": "male"},
    {"name": "ቅድስት አሸናፊ", "gender": "female"},
    {"name": "ሰላም አሸናፊ", "gender": "female"},
    {"name": "ቅድስት መላኩ", "gender": "female"},
    {"name": "ሜላት መንክር", "gender": "female"},
    {"name": "ኤልዳና አበበ", "gender": "male"},
    {"name": "ናታኒም ጌታሁን", "gender": "male"},
    {"name": "ኤልያና ኤርምያስ", "gender": "female"},
    {"name": "አኪያ ባርክልኝ", "gender": "female"},
    {"name": "ይስሀቅ አብርሀም", "gender": "male"},
    {"name": "እዮኤል ደረጀ", "gender": "male"},
    {"name": "ሱራፊል ገ/ማርያም", "gender": "female"},
    {"name": "አዶናይ ደረጀ", "gender": "male"},
    {"name": "ማእዶት ተገኘ", "gender": "female"},
    {"name": "አቤል ነጋ", "gender": "male"}
  



                ];
                
                if (confirm("No students found. Would you like to add some sample students?")) {
                    appData.masterStudents = sampleStudents;
                    localStorage.setItem('attendanceData', JSON.stringify(appData));
                    initializeApp();
                }
            }
        });
    </script>
</body>
</html>